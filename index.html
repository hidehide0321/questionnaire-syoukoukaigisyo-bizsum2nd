<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせフォーム</title>
  <style>
    :root {
      --bg: #f7f7f8; --panel: #ffffff; --text: #1f2328; --muted: #6e7781;
      --primary: #2563eb; --primary-hover: #1d4ed8; --danger: #dc2626;
      --success: #059669; --border: #e5e7eb;
    }
    body { margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif; line-height: 1.6; }
    .container { max-width: 720px; margin: 40px auto; padding: 24px; background: var(--panel);
      border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
    h1 { margin: 0 0 16px; font-size: 20px; }
    p.desc { margin: 0 0 24px; color: var(--muted); font-size: 14px; }
    .field { margin-bottom: 16px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
    input[type="text"], input[type="email"], textarea {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 14px; background: #fff; color: var(--text); box-sizing: border-box;
    }
    textarea { min-height: 140px; resize: vertical; }
    button[type="submit"] {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 16px; background: var(--primary); color: #fff; border: none; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color .15s, opacity .15s;
    }
    button[type="submit"]:hover { background: var(--primary-hover); }
    button[type="submit"]:disabled { opacity: .6; cursor: not-allowed; }
    .status { margin-top: 12px; font-size: 14px; }
    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }
    .hint { color: var(--muted); font-size: 12px; margin-top: 4px; }
  </style>
  <!-- 後で WEB_APP_URL を実際のURLに置換してください -->
</head>
<body>
  <main class="container">
    <h1>お問い合わせ</h1>
    <p class="desc">以下のフォームに必要事項をご入力の上、送信してください。</p>

    <form id="contactForm" novalidate>
      <div class="field">
        <label for="name">名前</label>
        <input id="name" name="name" type="text" required placeholder="山田 太郎" />
      </div>

      <div class="field">
        <label for="email">メールアドレス</label>
        <input id="email" name="email" type="email" required placeholder="taro@example.com" />
        <div class="hint">返信先として利用します。正しくご入力ください。</div>
      </div>

      <div class="field">
        <label for="message">メッセージ</label>
        <textarea id="message" name="message" required placeholder="お問い合わせ内容を記入してください。"></textarea>
      </div>

      <button type="submit" id="submitBtn">送信</button>
      <div id="status" class="status" aria-live="polite"></div>
    </form>
  </main>

  <script>
    // デプロイしたGAS WebアプリのURLに置き換えてください
    const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzLSmFmf2qNHg0nDJa_K4srE47p8phz6W69reBhWOnIUU1-P5LhrEjHumXiwDw0w_W8/exec';
    const params = new URL(window.location.href).searchParams;
    const endpointFromQuery = params.get('endpoint');
    const endpointFromStorage = window.localStorage.getItem('WEB_APP_URL') || '';
    if (endpointFromQuery) {
      try { window.localStorage.setItem('WEB_APP_URL', endpointFromQuery); } catch (_) {}
    }
    const WEB_APP_URL = endpointFromQuery || endpointFromStorage || DEFAULT_WEB_APP_URL;
    
    const form = document.getElementById('contactForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');

    // 送信イベントハンドラ（スタートはここから）
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!form.reportValidity()) return;

      const originalLabel = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '送信中...';
      statusEl.textContent = '';
      statusEl.className = 'status';

      try {
        // CORSプリフライトを避けるため x-www-form-urlencoded を使用
        const params = new URLSearchParams();
        params.append('name', form.name.value.trim());
        params.append('email', form.email.value.trim());
        params.append('message', form.message.value.trim());

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: params
        });

        if (!res.ok) {
          throw new Error('ネットワークエラー (' + res.status + ')');
        }

        const data = await res.json();
        if (data.status === 'success') {
          statusEl.textContent = '送信しました！ありがとうございます。';
          statusEl.classList.add('success');
          form.reset();
        } else {
          throw new Error(data.message || '送信に失敗しました。');
        }
      } catch (err) {
        statusEl.textContent = 'エラー: ' + (err && err.message ? err.message : String(err));
        statusEl.classList.add('error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalLabel;
      }
    });
    // 送信イベントハンドラ（ここまで）
  </script>
</body>
</html>
